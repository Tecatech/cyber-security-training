#!/usr/bin/env python3
from requests import Session
import re
import secrets
import sys

url = sys.argv[1]
login = secrets.token_hex(10)
password = login

sess = Session()
resp = sess.post(url + '/register', data = {'login': login, 'password': password})
resp = sess.post(url + '/login', data = {'login': login, 'password': password})

fileinfo_regexp = re.compile(r'<div class="filenames">(.*)</div>')
filename_link = re.compile(r'<div class="message">Your fanfic was uploaded to (uploads/.*)</div>')

uploads_html = sess.get(url + '/uploads?limit=128&offset=0').text
files_info = fileinfo_regexp.findall(uploads_html)
filenames = [f"{x.split(': ')[0]}_{x.split(': ')[1]}" for x in files_info]

for filename in filenames:
    link = f'file:///services/doseo/uploads/{filename}'
    resp = sess.post(url + '/upload_by_link', data = {'link': link})
    link = filename_link.findall(resp.text)[0]
    upload = sess.get(url + '/' + link).text
    print(upload, flush = True)