<?php
  if (empty($_GET["errors"])){
    require_once "config.inc.php";
  }
  session_start();

  if (isset($_GET["start_the_game"]) && isset($_SESSION["id"])){
    $_SESSION["game_started"] = True;
  }
  if ($_SESSION["game_started"]){
    header("Location: /desk.php");
    exit();
  }

  if (isset($_POST["info"]) && isset($_SESSION["id"])){
    $sth = $conn->prepare("UPDATE users SET userinfo = :userinfo WHERE id = " . $_SESSION["id"]);
    $sth->bindParam(':userinfo', $_POST["info"], PDO::PARAM_STR);
    $sth->execute();
  }

  if (isset($_FILES["cardtheme"]) && isset($_SESSION["id"])){
    $filename = "/var/www/templates/themes/cards_" . $_SESSION["id"] . ".zip";
    if (file_exists($filename)){
      unlink($filename);
    }
    move_uploaded_file($_FILES['cardtheme']['tmp_name'], $filename);

    // unpack cards
    if (strpos(exec("file " . $filename), "Zip archive data")) {
      $themepath = "/var/www/html/images/cards/cards_" . $_SESSION["id"];
      exec("rm -rf " . $themepath);
      exec("mkdir " . $themepath);
      exec("unzip " . $filename . " -d " . $themepath);
      exec("rm -rf /var/www/templates/themes/cards_" . $_SESSION["id"]);
      exec("mkdir /var/www/templates/themes/cards_" . $_SESSION["id"]);
      exec("mv " . $themepath . "/README.txt /var/www/templates/themes/cards_" . $_SESSION["id"]);

      $sth = $conn->prepare("UPDATE users SET cardtheme = 'cards_" . $_SESSION["id"] . "' WHERE id = " . $_SESSION['id']);
      $sth->execute();
    } else {
      unlink($filename);
      header("Location: /?errors[]=This is not zip archive!");
    }
  }
?>
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" content="width=device-width, initial-scale=1">
  <title>Durak - Card game</title>
  <link rel="stylesheet" type="text/css" href="css/style.css">
  <script src="js/jquery.js"></script>
  <script src="js/animation.js"></script>
</head>
<body>

  <div class="topnav">
    <a class="active" href="/index.php">Home</a>
    <a href="/leaderboard.php">Leaderboard</a>

  <?php

    if (empty($_SESSION)){
      $output .= '  <div class="login-container">';
      $output .= '    <form action="/login.php" method="post">';
      $output .= '      <input type="text" placeholder="Username" name="username">';
      $output .= '      <input type="text" placeholder="Password" name="password">';
      $output .= '      <button class="button" name="type" value="login" type="submit">Login</button>';
      $output .= '      <button class="button" name="type" value="register" type="submit">Register</button>';
      $output .= '    </form>';
      $output .= '  </div>';
    } else {
      $output .= '  <div class="login-container">';
      $output .= '    <form action="/login.php" method="post">';
      $output .= '      <button name="logout" value="logout" type="submit">Logout</button>';
      $output .= '    </form>';
      $output .= '  </div>';
    }
    echo $output;
  ?>
  </div>

  <?php
    if (isset($_GET['errors'])){
      echo '<form name="description" action="index.php" method="get" id="start-form">';
      echo '  <div><h1>"Durak" - Card game</h1></div>
        <div><img src="images/deck-of-cards.png"></div>';
      echo '<div class="description" style="color: red;"><br>';
      foreach($_GET['errors'] as $error){
        echo htmlspecialchars($error) . '<br/>';
      }
      echo '</div>';
      exit();
    }
    if (isset($_SESSION["id"])){
      include "/var/www/templates/menu_left.php";
    }
  ?>

  <form name="description" action="index.php" method="get" id="start-form">
  <div><h1>"Durak" - Card game</h1></div>
  <div><img src="images/deck-of-cards.png"></div>
  <?php
    if (empty($_SESSION)){
      echo '<div class="description">Durak is a Russian card game that is popular in post-Soviet states. The object of the game is to get rid of all one\'s cards. At the end of the game, the last player with cards in their hand is referred to as the fool ("durak").</div>';
    } else if (!$_SESSION['game_started']){
      $output = '';
      $output .= '<form name="start-the-game" action="index.php" id="start-form">';
      $output .= '<button class="button" name="start_the_game" value="start_the_game" type="submit">Start the game</button>';
      $output .= '</form>';

      echo $output;
    }
  ?>
  </form>

  <?php
    if (isset($_SESSION["id"])){
      include "/var/www/templates/menu_right.php";
    }
  ?>

</body>
</html>
