<?php

include_once 'Desk.php';
include_once 'PackOfCards.php';

class Player
{
    const CARDS_IN_HAND = 6;
    private $hand;
    private $cardtheme;

    public function __construct($hand = [])
    {
        $this->hand = $hand;

        require "config.inc.php";
        $sth = $conn->prepare("SELECT cardtheme from users where id = " . $_SESSION['id']);
        $sth->execute();
        $data = $sth->fetch(PDO::FETCH_ASSOC);

        $this->cardtheme = $data["cardtheme"];
    }

    public function getHand()
    {
        return $this->hand;
    }

    public function setHand($packOfCards)
    {
        if (empty($this->hand)) {
            $amount = self::CARDS_IN_HAND;
        } else {
            $amount = self::CARDS_IN_HAND - count($this->hand);
        }

        if ($amount > 0) {
            $handAppend = $packOfCards->dealTheCards($amount);
            if ($handAppend != 0) {
                if (is_array($handAppend)) {
                    $this->hand = array_merge($this->hand, $handAppend);
                } elseif (is_string($handAppend)) {
                    $this->hand[] = $handAppend;
                }
            }
        }
    }

    public function passTheCard($card)
    {
        $key = array_search($card, $this->hand);
        unset($this->hand[$key]);
    }

    public function pickUpCard($card)
    {
        if ($card != 0) {
            $this->hand[] = $card;
        }
    }

    public function renderCards($desk)
    {
        $output = '';
        if (!empty($this->hand)) {
            foreach ($this->hand as $key => $value) {
                $output .= '<button type="submit" name="card" value="' . $value . '"';
                if (($desk->getWhichAction() === 'attack' || $desk->getWhichAction() === 'defense') && $desk->validateCard($value)) {
                    $output .= 'class="popup-' . ++$key . '"';
                } elseif ($desk->getWhichAction() === 'extraCard' && $desk->validateExtraCard($value)) {
                    $output .= 'class="popup-' . ++$key . '"';
                } else {
                    $output .= 'disabled';
                }
                $output .= '><img src="images/cards/' . $this->cardtheme . '/' . $value . '.png"></button>';
            }
        } else {
            $_SESSION['gameWinner'] = 'player';
            $output .= '<script type="text/javascript">location.href = "/desk.php";</script>';
        }
        return $output;
    }

    public function getInfo()
    {
        require "config.inc.php";
        $sth = $conn->prepare("SELECT wins,losses from users where id = " . $_SESSION['id']);
        $sth->execute();
        $data = $sth->fetch(PDO::FETCH_ASSOC);

        return $data["wins"] . " wins, " . $data["losses"] . " losses";
    }

    public function updateInfo()
    {
        require "config.inc.php";
        if ($_SESSION['gameWinner'] == 'player') {
          $sth = $conn->prepare("UPDATE users SET wins = wins+1 WHERE id = " . $_SESSION['id']);
          $sth->execute();
        } else {
          $sth = $conn->prepare("UPDATE users SET losses = losses+1 WHERE id = " . $_SESSION['id']);
          $sth->execute();
        }
    }

    public function addDataToSession()
    {
        setcookie('Player', serialize($this));
    }
}
