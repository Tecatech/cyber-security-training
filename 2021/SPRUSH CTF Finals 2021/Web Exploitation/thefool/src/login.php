<?php
session_start();
require_once "config.inc.php";

if (isset($_POST['logout'])){
    session_destroy();
    header("Location: /");
    die();
}

if (isset($_POST['type'])){
  $login = $_POST['username'];
  $password= $_POST['password'];
  $errors = array();

  if(empty($login)){
		$errors[] = "Login field is required";
	}
	if(empty($password)){
		$errors[] = "Password field is required";
	}

  if(empty($errors) && $_POST['type'] == 'login' ) {
		$sth = $conn->prepare("SELECT * FROM users WHERE login = '" . $login . "' LIMIT 1");
		$sth->execute();
		$user = $sth->fetch(PDO::FETCH_ASSOC);
		if(!empty($user)) {
			if (password_verify($password, $user['password'])) {
				$_SESSION['id'] =  $user['id'];
				$_SESSION['name'] =  $user['login'];
        $_SESSION['game_started'] = False;
				header("Location: index.php");
			}	else {
				$errors[] = "Login error";
			}

		}	else {
			$errors[] = "Login error";
		}
	} else if(empty($errors) && $_POST['type'] == 'register' ){
    $sth = $conn->prepare("SELECT * FROM users WHERE login = :login LIMIT 1");
		$sth->bindParam(':login', $login, PDO::PARAM_STR);
		$sth->execute();
		$user = $sth->fetch(PDO::FETCH_OBJ);
    if (!$user){
      $sql = "INSERT INTO `users` (`login`, `password`) VALUES (:login, :password)";
      $stmt = $conn->prepare($sql);
      $stmt->bindParam(':login', $login);
      $stmt->bindParam(':password', password_hash($password, PASSWORD_BCRYPT));
      $stmt->execute();
    } else {
      $errors[] = "User already registered";
    }
  }

  if (!empty($errors)){
    $out = '';
    foreach($errors as $error){
      $out .= 'errors[]=' . $error . '&';
    }
    header("Location: /?" . $out);
    die();
  }
  header("Location: /");
}

?>
