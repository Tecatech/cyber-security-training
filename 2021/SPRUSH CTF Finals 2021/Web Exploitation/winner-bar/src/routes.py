from app import app
from flask import render_template, request, session, redirect, url_for
from db import *

@app.route('/', methods=['GET'])
def welcome_to_the_bar():
    return render_template('welcome.html')


@app.route('/register', methods=['GET', 'POST'])
def register():
    msg = ""
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        if user_exists(username):
            msg = "User exists"
        else:
            add_user(username, password)
            msg = "Successfully registered!"
    return render_template('register.html', message=msg)


@app.route('/login', methods=['GET', 'POST'])
def login():
    msg = ""
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        if verify_user(username, password):
            session["current_user"] = username.strip()
            return redirect(url_for('my_bar'))
        else:
            msg = "Invalid credentials"
    return render_template('login.html', message=msg)

@app.route('/my_bar')
def my_bar():
    if session["current_user"]:
        bottle_names = get_bottles(session["current_user"])
        cocktail_names = get_cocktails(session["current_user"])
        return render_template('my_bar.html', bnames = bottle_names, cnames = cocktail_names)
    else:
        return redirect(url_for('welcome_to_the_bar'))

@app.route('/add_bottle', methods=['GET', 'POST'])
def add_bottle():
    if session["current_user"]:
        if request.method == 'POST':
            bottle = request.form['bottle']
            save_bottle(bottle, session["current_user"])
            return redirect(url_for('my_bar'))
        return render_template('add_bottle.html')
    else:
        return redirect(url_for('welcome_to_the_bar'))


@app.route('/make_cocktail', methods=['GET', 'POST'])
def make_cocktail():
    msg = ""
    if session["current_user"]:
        if request.method == 'POST':
            cocktail_name = request.form['cocktail_name']
            first_ingredient = request.form['first']
            second_ingredient = request.form['second']
            desc = request.form['desc']

            msg = save_cocktail(cocktail_name, first_ingredient, second_ingredient, session["current_user"], desc)
            if msg == "":
                return redirect(url_for('my_bar'))
            else:
                return render_template('make_cocktail.html', message=msg)
        return render_template('make_cocktail.html')
    else:
        return redirect(url_for('welcome_to_the_bar'))

@app.route('/share_bottle', methods=['GET', 'POST'])
def share_bottle():
    if session["current_user"]:
        if request.method == 'POST':
            share_to = request.form['share_to']
            share = request.form['share']
            bottle_name = request.form['bottle']
            msg = add_shared_bottle(share_to, share, bottle_name)
            if msg != '':
                return render_template('share_bottle.html', message=msg)
        else:
            return render_template('share_bottle.html')
        return redirect(url_for('my_bar'))
    else:
        return redirect(url_for('welcome_to_the_bar'))


@app.route('/cocktails', methods=['GET'])
def all_cocktails():
    cnames = get_all_cocktails()
    return render_template('all_cocktails.html', cnames=cnames)

@app.route('/cocktail/<id>')
def cocktail_profile(id):
    user = session["current_user"]
    if user:
        cocktail = get_cocktail_by_id(id)
        if cocktail and (user in cocktail[3] or request.args.get('secret') == str(cocktail[6])):
            return render_template('profile.html', cocktail=cocktail)
        else:
            return redirect(url_for('all_cocktails'))
    else:
        return redirect(url_for('welcome_to_the_bar'))




@app.route('/logout')
def logout():
    session.clear()
    return redirect(url_for('welcome_to_the_bar'))
