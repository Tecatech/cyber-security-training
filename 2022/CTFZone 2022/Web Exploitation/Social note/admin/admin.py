#!/usr/bin/env python3
import requests
import random
import string
import functools
import os
from bs4 import BeautifulSoup
from time import sleep

def randStr(strLen=16):
    letters = string.ascii_letters + string.digits
    return ''.join(random.choice(letters) for i in range(strLen))

url = "http://web:5000"
username = "ctfzone_admin"
password = randStr()
notes = [
            os.environ.get("FLAG"),
            "The fact is that for some reason I am dying. They all interrogate me, what happened to me, and why I am silent, and why I am dying. And these questions are the most difficult for me now. I know that they ask out of love and they want to help me, but I am terribly afraid of these questions. Do people always know why they die?",
            "Man is doomed to freedom.",
            "I wonder if all these people felt sorry for me or disgusted?",
            "Determinism has long ceased to have a foundation, as well as the basis of materialism, which is still rubbed in thin portions in the lessons of natural science and philosophy. All of this was refuted by a new paradigm at the end of the twentieth century.",
            "At the patriarchal dump of obsolete concepts",
            "Used images and polite words",
            "...to destroy the world by killing yourself",
            "To destroy the world by killing yourself",
            "Compassionate laughter, like frost",
            "Compassionate laughter, like frost",
            "Compassionate laughter, like frost",
            "Compassionate laughter, like frost",
            "The Russian Field of Experiments",
            "The Russian Field of Experiments",
            "The Russian Field of Experiments",
            "The Russian Field of Experiments",
            "Pain and suffering are always inevitable for a large intelligence and a deep heart. The really great men must, I think, have great sadness on earth.",
            "What is hell? I maintain that it is the suffering of being unable to love.",
            "Man only likes to count his troubles; he doesn't calculate his happiness.",
            "The holiday is essential. And if this Holiday is not there, then this life is fucking unnecessary, at all. Hence suicides and deaths arise; hired soldiers, parachutists, climbers and extreme sports arise from here - all this is the way out, at least a terrible adrenaline"
        ]

random.shuffle(notes)

s = requests.Session()
s.request = functools.partial(s.request, timeout=1)

sleep(5)
while 1:
    try:
        r = s.get(f"{url}/register")
        csrf = BeautifulSoup(r.text, features="lxml").find("input", {"id": "csrf_token"})["value"]

        register = s.post(f"{url}/register",
                            data={
                                "csrf_token": csrf,
                                "username": username,
                                "password": password
                            })
        if "Register failed." in register.text:
            break
        csrf = BeautifulSoup(r.text, features="lxml").find("input", {"id": "csrf_token"})["value"]

        login = s.post(f"{url}/login",
                            data={
                                "csrf_token": csrf,
                                "username": username,
                                "password": password
                            })

        csrf = BeautifulSoup(r.text, features="lxml").find("input", {"id": "csrf_token"})["value"]
        print("[*] REG ADMIN")
        print(username)
        print(password)
        for note in notes:
            reg_note = s.post(f"{url}/notes/{username}",
                                data={
                                    "csrf_token": csrf,
                                    "note_name": note,
                                    "submit_button": "Add note"
                                })
            csrf = BeautifulSoup(r.text, features="lxml").find("input", {"id": "csrf_token"})["value"]
        print()
        break
    except Exception as e:
        print(f"[-] {e}")
        sleep(1)
