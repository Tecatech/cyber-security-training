#!/usr/bin/python3
import ast
import os
import sys

def verify_secure(m):
    for x in ast.walk(m):
        match type(x):
            case (ast.Import | ast.ImportFrom | ast.Call):
                print(f"ERROR: Banned statement {x}")
                return False
    return True

abspath = os.path.abspath(__file__)
dname = os.path.dirname(abspath)
os.chdir(dname)

print("-- Please enter code (last line must contain only --END)")

source_code = ""
while True:
    line = sys.stdin.readline()
    if line.startswith("--END"):
        break
    source_code += line

tree = compile(source_code, "treebox_script.py", 'exec', flags = ast.PyCF_ONLY_AST)
if verify_secure(tree):
    print("-- Executing safe code:")
    compiled = compile(source_code, "treebox_script.py", 'exec')
    exec(compiled)